<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Noto+Sans+JP:wght@300;400;700&display=swap" rel="stylesheet">
<title>米粉のしふぉん まつぼっくり</title>

<link rel="stylesheet" href="css/styles.css">
</head>

<body>
<div class="device-frame">

<header>
  <div class="header-inner">
    <div class="hamburger" onclick="toggleMenu()" aria-expanded="false" role="button" tabindex="0">☰</div>
    <div class="header-logo-wrap">
      <!-- ユーザー指定のアイコンを相対パスで読み込み -->
      <img class="header-logo" src="image/アイコン.png" alt="米粉のしふぉん　まつぼっくり" onerror="this.style.display='none'; this.parentElement.classList.add('noimg')">
      <div class="placeholder">ヘッダーロゴは <code>image/アイコン.png</code> にアップロードしてください</div>
    </div>
    <div class="logo">米粉のしふぉん　まつぼっくり</div>
  </div>
  <nav id="nav">
    <ul>
      <li><a href="index.html" onclick="toggleMenu()">トップ</a></li>
      <li><a href="about.html" onclick="toggleMenu()">お店のこだわり</a></li>
      <li><a href="menu.html" onclick="toggleMenu()">メニュー</a></li>
      <li><a href="reservation.html" onclick="toggleMenu()">予約について</a></li>
      <li><a href="parking.html" onclick="toggleMenu()">駐車場について</a></li>
    </ul>
  </nav>
</header>

<main>

<section class="hero">
  <div class="hero-inner card">
    <div class="hero-image" id="heroImageWrap">
    <div class="hero-text">
      <div class="about-block">
        <div class="about-image" data-images="image/image5.jpeg,image/image2.jpeg,image/image6.jpeg">
          <img id="aboutImg" src="image/image5.jpeg" alt="雪ほたかの米粉を使ったシフォン">
          <div class="img-placeholder">画像を <code>image/</code> にアップロードしてください</div>
        </div>
        <p id="aboutText">雪ほたかの米粉100%を使用したグルテンフリーのシフォンケーキ専門店。国産米中心の飼料で育った鶏の卵を使い、保存料や着色料は不使用。お子様から大人まで安心して楽しめます。</p>
      </div>
    </div>
  </div>
</section>

<section id="news">
  <h2 class="section-title">最新のお知らせ</h2>
  <div class="card" id="latestNews">
    <!-- JS で data/news.json の最新を表示 -->
  </div>
  <div style="text-align:right; margin-top:6px;"><a href="news.html" class="btn" style="background:#fff;color:var(--text);border:1px solid #eee;">お知らせ一覧へ</a></div>
</section> 

<section id="menu">
  <h2 class="section-title">メニュー</h2>
  <div class="card">
    <div class="menu-grid" id="menuGrid">
      <!-- JS でメニューを読み込み可能（画像は image/ に配置） -->
      <div class="menu-item">
        <div class="menu-item-image"><img src="image/image3.jpeg" alt="プレーン" onerror="this.style.display='none'; this.closest('.menu-item-image').classList.add('noimg');"></div>
        <div class="menu-item-body"><h3>プレーン</h3></div>
        <div class="price">¥280</div>
      </div>

      <div class="menu-item">
        <div class="menu-item-image"><img src="image/image3.jpeg" alt="紅茶" onerror="this.style.display='none'; this.closest('.menu-item-image').classList.add('noimg');"></div>
        <div class="menu-item-body"><h3>紅茶</h3></div>
        <div class="price">¥320</div>
      </div>

      <div class="menu-item">
        <div class="menu-item-image"><img src="image/image3.jpeg" alt="抹茶" onerror="this.style.display='none'; this.closest('.menu-item-image').classList.add('noimg');"></div>
        <div class="menu-item-body"><h3>抹茶</h3></div>
        <div class="price">¥350</div>
      </div>

      <div class="menu-item">
        <div class="menu-item-image"><img src="image/image3.jpeg" alt="チョコ" onerror="this.style.display='none'; this.closest('.menu-item-image').classList.add('noimg');"></div>
        <div class="menu-item-body"><h3>チョコ</h3></div>
        <div class="price">¥350</div>
      </div>

    </div>
    <div style="margin-top:12px;">
      <table class="simple-menu" style="width:100%; font-size:14px; border-collapse:collapse;">
        <tbody>
          <tr><td>プレーンしふぉん</td><td style="text-align:right">¥200</td></tr>
          <tr><td>生シフォン</td><td style="text-align:right">¥400</td></tr>
          <tr><td>フォンダンショコラ</td><td style="text-align:right">¥250</td></tr>
          <tr><td>プリン</td><td style="text-align:right">¥200</td></tr>
        </tbody>
      </table>
      <p style="font-size:12px;color:#666;margin-top:6px;">※価格はすべて税込みです。</p>
    </div>
  </div>
</section>

<section id="calendar">
  <h2 class="section-title">営業日</h2>
  <div class="card">
    <div style="display:flex; flex-direction:column; justify-content:center; align-items:center; margin-bottom:8px;">
      <div id="calTitle" style="font-weight:700; color:var(--text);"></div>
      <div id="calHours" style="font-size:13px;color:#666;margin-top:4px;">11:00-18:00（売切次第終了）</div>
    </div>
    <div id="calendarGrid" class="calendar">
      <!-- カレンダーはここに描画されます -->
    </div>
    <div style="margin-top:8px; font-size:12px; color:#666;"><strong>表示の説明：</strong><span style="display:inline-block; padding:4px 8px; background:#ffe0e0; border-radius:4px; margin-left:8px;">定休日</span></div> 
  </div>
</section>

<section id="access">
  <h2 class="section-title">アクセス</h2>
  <div class="card">
    <p id="shopAddress">群馬県藤岡市中島290-1</p>
    <iframe
      id="mapFrame"
      src="https://www.google.com/maps?q=群馬県藤岡市中島290-1&output=embed"
      width="100%" height="220" style="border:0;" loading="lazy"></iframe>
    <noscript><p style="font-size:13px;color:#666;margin-top:8px;"><a href="https://www.google.com/maps?q=群馬県藤岡市中島290-1" target="_blank" rel="noopener">地図を別タブで開く（iframe無効時の代替）</a></p></noscript>
  </div>
</section>

</main>

<footer>
  <div class="footer-wrap">
    <a href="https://www.instagram.com/matsubokkuri_2024/" target="_blank" rel="noopener noreferrer" class="footer-instalink" aria-label="Instagram">
      <img class="footer-icon" src="image/instagram.png" alt="Instagram" onerror="this.onerror=null; this.src='image/logo.png';">
    </a>
    <div>@matsubokkuri_2024</div>
  </div>
  <div style="margin-top:8px; text-align:center; color:#fff;">(アイコンをクリックするとInstagramへ移動します)</div>
  <div style="margin-top:8px; text-align:center; font-size:12px; color:#f5efe9; opacity:0.95;">© 2025 米粉のしふぉん　まつぼっくり — ページ内の文章・写真の無断転載を禁じます。</div>
</footer>

</div>

<script>
// toggleMenu already present earlier
function toggleMenu() {
  const nav = document.getElementById("nav");
  const hb = document.querySelector('.hamburger');
  if (!nav) return;
  const isOpen = nav.classList.toggle('open');
  if (hb) hb.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
}
// keyboard support for hamburger (Enter / Space)
document.addEventListener('keydown', (e)=>{
  const hb = document.querySelector('.hamburger');
  if (!hb) return;
  if (document.activeElement === hb && (e.key === 'Enter' || e.key === ' ')) { e.preventDefault(); toggleMenu(); }
});

// --- Shop data loader ---
async function loadShopData() {
  try {
    const res = await fetch('data/shop.json');
    const shop = await res.json();
    const nameEl = document.getElementById('shopName'); if (nameEl) nameEl.textContent = shop.name;
    const descEl = document.getElementById('shopDesc'); if (descEl) descEl.textContent = shop.description;
    const hoursEl = document.getElementById('shopHours'); if (hoursEl) hoursEl.textContent = shop.openingHours;
    const notesEl = document.getElementById('shopNotes'); if (notesEl) notesEl.textContent = shop.notes || '';
    const addrEl = document.getElementById('shopAddress'); if (addrEl) addrEl.textContent = shop.address;
    const headerAddrEl = document.getElementById('headerAddress'); if (headerAddrEl) headerAddrEl.textContent = shop.address.replace(/^〒\d{3}-\d{4}\s*/, '');
    const headerInfoEl = document.getElementById('headerInfo'); if (headerInfoEl) headerInfoEl.innerHTML = `定休日　${(shop.holidays||[]).join('・')}<br>OPEN　${(shop.openingHours||'11:00-18:00').replace('-','　CLOSE　')}（売切次第終了）`;
    const holidayEl = document.getElementById('holidayText'); if (holidayEl) holidayEl.textContent = shop.holidays.join('・');
    const calHoursEl = document.getElementById('calHours'); if (calHoursEl) calHoursEl.textContent = (shop.openingHours? `${shop.openingHours}（売切次第終了）` : '11:00-18:00（売切次第終了）');

    // Set JSON-LD for local business
    const ld = {
      "@context":"https://schema.org",
      "@type":"FoodEstablishment",
      "name": shop.name,
      "description": shop.description,
      "address": {
        "@type": "PostalAddress",
        "addressLocality": shop.address
      },
      "openingHours": shop.openingHours
    };
    const script = document.createElement('script'); script.type='application/ld+json'; script.text = JSON.stringify(ld);
    document.head.appendChild(script);

  } catch (e) {
    console.warn('shop.json の読み込みに失敗しました', e);
  }
}

// --- News loader ---
async function loadNews() {
  try {
    const r = await fetch('data/news.json');
    if (!r.ok) throw new Error('no-file');
    const arr = await r.json();
    const el = document.getElementById('latestNews');
    if (!Array.isArray(arr) || arr.length===0) { el.innerHTML = '<p>お知らせはありません</p>'; return; }
    const latest = arr[0];
    el.innerHTML = `<p style="font-weight:700">${latest.date}</p><p>${latest.text}</p>`;
  } catch (e) {
    console.warn('news.json の読み込み失敗', e);
    const el = document.getElementById('latestNews'); if (el) el.innerHTML = '<p>お知らせの読み込みに失敗しました</p>';
  }
}

// --- Calendar: fetch per month if available, fallback to closedDaysOfWeek ---
async function fetchCalendarData(year, month) {
  // month is 1-based here
  const path = `calendar/${year}-${String(month).padStart(2,'0')}.json`;
  try {
    const r = await fetch(path);
    if (!r.ok) throw new Error('no-file');
    const data = await r.json();
    return data;
  } catch (e) {
    // fallback
    return { year, month, closedDaysOfWeek: [1,2], notes: {} };
  }
}

function buildCalendar(container, data) {
  container.innerHTML = '';
  // header row
  const days = ['日','月','火','水','木','金','土'];
  for (let d of days) {
    const el = document.createElement('div'); el.textContent = d; el.style.fontWeight='700'; container.appendChild(el);
  }
  const first = new Date(data.year, data.month-1, 1);
  const last = new Date(data.year, data.month, 0);
  const start = first.getDay();
  // blank cells
  for (let i=0;i<start;i++) { const e=document.createElement('div'); container.appendChild(e); }
  for (let d=1; d<=last.getDate(); d++) {
    const date = new Date(data.year, data.month-1, d);
    const cell = document.createElement('div');
    const dateSpan = document.createElement('span'); dateSpan.className='date-num'; dateSpan.textContent = d; cell.appendChild(dateSpan);
    const key = `${data.year}-${String(data.month).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const labels = [];
    if (data.closedDaysOfWeek.includes(date.getDay())) {
      cell.classList.add('closed');
      labels.push('定休日');
    }

    // highlight today
    const today = new Date();
    if (date.getFullYear() === today.getFullYear() && date.getMonth() === today.getMonth() && date.getDate() === today.getDate()) {
      cell.classList.add('today');
      labels.push('本日');
    }
    if (data.notes && data.notes[key]) {
      labels.push(data.notes[key]);
    }
    if (labels.length) cell.title = labels.join(' / ');
    // click to show note
    cell.addEventListener('click', ()=>{
      if (cell.title) alert(`${data.year}年${data.month}月${d}日\n${cell.title}`);
    });
    container.appendChild(cell);
  }
}

// --- Slideshow initializer ---
function initSlideshow(){
  const slides = Array.from(document.querySelectorAll('#slides .slide'));
  const placeholder = document.getElementById('slidesPlaceholder');
  // ensure debug element
  const debugEl = (function(){
    let d = document.getElementById('slideDebug');
    if(!d){ d = document.createElement('div'); d.id='slideDebug'; d.className='slide-debug'; d.setAttribute('aria-hidden','true'); const slidesContainer = document.getElementById('slides'); if (slidesContainer) slidesContainer.appendChild(d); }
    return d;
  })();

  if (!slides || slides.length===0) {
    if (placeholder) placeholder.style.display='flex';
    if (debugEl) debugEl.textContent = 'no slides';
    return;
  }

  slides.forEach(s=>{
    s.classList.remove('active','hidden');
    s.addEventListener('error', ()=>{ s.dataset.broken = '1'; s.classList.add('hidden'); logStatus(); checkAndFallback(); console.warn('slide error', s.src); });
    s.addEventListener('load', ()=>{ s.dataset.broken = '0'; s.classList.remove('hidden'); logStatus(); checkAndFallback(); });
  });

  let idx = 0;
  let timerId = null;

  function getAvailable(){
    return slides.filter(s=> !(s.dataset.broken === '1') && !s.classList.contains('hidden') && s.src);
  }

  function logStatus(){
    if(!debugEl) return;
    const rows = slides.map((s,i)=>{
      return `${i+1}: ${s.src.split('/').pop()} ${s.dataset.broken==='1'?'[BROKEN]':''} ${s.classList.contains('hidden')?'[HIDDEN]':''} ${s.complete? (s.naturalWidth? '[OK]':'[ZERO]') : '[LOADING]' }${s.classList.contains('active')?' [ACTIVE]':''}`;
    });
    debugEl.textContent = rows.join('\n');
  }

  function checkAndFallback(){
    const avail = getAvailable();
    logStatus();
    if (avail.length === 0) {
      slides.forEach(s=> s.classList.remove('active'));
      if (placeholder) placeholder.style.display='flex';
      if (timerId) { clearInterval(timerId); timerId = null; }
      return;
    }
    if (placeholder) placeholder.style.display='none';

    // ensure an active slide
    if (!slides.some(s=> s.classList.contains('active'))) {
      avail[0].classList.add('active');
      idx = slides.indexOf(avail[0]);
      logStatus();
    } else {
      const active = slides.findIndex(s=> s.classList.contains('active'));
      idx = active >= 0 ? active : slides.indexOf(avail[0]);
    }

    if (timerId && avail.length <= 1) { clearInterval(timerId); timerId = null; }
    if (!timerId && avail.length > 1) {
      timerId = setInterval(()=>{
        const curAvail = getAvailable();
        if (curAvail.length <= 1) return;
        const current = slides[idx];
        const pos = curAvail.indexOf(current);
        const nextPos = (pos === -1) ? 0 : (pos + 1) % curAvail.length;
        const nextSlide = curAvail[nextPos];
        if (!nextSlide) return;
        slides[idx] && slides[idx].classList.remove('active');
        nextSlide.classList.add('active');
        idx = slides.indexOf(nextSlide);
        logStatus();
      }, 5000);
    }
  }

  // initial evaluation for cached images
  slides.forEach(s=>{
    if (s.complete) {
      if (s.naturalWidth === 0) { s.dataset.broken='1'; s.classList.add('hidden'); }
      else { s.dataset.broken='0'; s.classList.remove('hidden'); }
    }
  });

  // small forced fallback: if none available after 500ms but there are slides, try showing first non-broken even if not loaded
  setTimeout(()=>{
    const avail = getAvailable();
    if (avail.length === 0) {
      const candidate = slides.find(s=> s.dataset.broken !== '1');
      if (candidate) {
        candidate.classList.remove('hidden');
        candidate.classList.add('active');
        idx = slides.indexOf(candidate);
        if (placeholder) placeholder.style.display='none';
        logStatus();
      }
    }
  }, 500);

  // run a check after a short delay to let images start loading
  setTimeout(checkAndFallback, 80);
}

let currentCal = (new Date());
async function renderCurrentMonth(offset=0) {
  const dt = new Date(currentCal.getFullYear(), currentCal.getMonth()+offset, 1);
  currentCal = dt;
  const y = dt.getFullYear(), m = dt.getMonth()+1;
  document.getElementById('calTitle').textContent = `${y}年 ${m}月`;
  const data = await fetchCalendarData(y,m);
  buildCalendar(document.getElementById('calendarGrid'), data);
}

// navigation disabled: only current month is shown (前月/次月ナビは不要のため削除) 

// init
loadShopData();
loadNews();
initSlideshow();
initAboutSlideshow();
renderCurrentMonth(0);

// --- About image slideshow (cycles image in `.about-image`) ---
function initAboutSlideshow(interval = 5000) {
  const aboutWrap = document.querySelector('.about-image');
  if (!aboutWrap) return;
  let placeholder = aboutWrap.querySelector('.img-placeholder');
  if (!placeholder) {
    placeholder = document.createElement('div'); placeholder.className='img-placeholder'; placeholder.textContent='画像をアップロードしてください'; aboutWrap.appendChild(placeholder);
  }
  let imgEl = aboutWrap.querySelector('#aboutImg');

  // gather images: dataset.images > global ABOUT_IMAGES > slides in hero > existing img src
  let images = [];
  if (aboutWrap.dataset.images) images = aboutWrap.dataset.images.split(',').map(s=>s.trim()).filter(Boolean);
  else if (window.ABOUT_IMAGES && Array.isArray(window.ABOUT_IMAGES)) images = window.ABOUT_IMAGES.slice();
  else {
    const slideImgs = Array.from(document.querySelectorAll('#slides .slide')).map(s=>s.src).filter(Boolean);
    if (slideImgs.length) images = slideImgs;
    else if (imgEl && imgEl.src) images = [imgEl.src];
  }

  if (!imgEl) {
    imgEl = document.createElement('img'); imgEl.id = 'aboutImg'; imgEl.alt = '店の写真'; aboutWrap.insertBefore(imgEl, placeholder);
  }

  let idx = 0;
  const broken = {};
  let timer = null;

  function loadImage(i) {
    if (!images[i]) return;
    aboutWrap.classList.remove('noimg');
    imgEl.classList.add('fading');
    imgEl.style.display = 'block';
    imgEl.onload = () => { imgEl.classList.remove('fading'); if (placeholder) placeholder.style.display='none'; };
    imgEl.onerror = () => { broken[images[i]] = true; imgEl.style.display='none'; if (placeholder) placeholder.style.display='flex'; nextImage(); };
    imgEl.src = images[i];
  }

  function nextImage() {
    if (images.length === 0) return;
    for (let i=1;i<=images.length;i++){
      const j = (idx + i) % images.length;
      if (!broken[images[j]]) { idx = j; loadImage(idx); return; }
    }
    // all broken
    if (placeholder) { imgEl.style.display='none'; aboutWrap.classList.add('noimg'); placeholder.style.display='flex'; }
  }

  // initial display
  if (images.length === 0) { if (placeholder) placeholder.style.display='flex'; return; }
  loadImage(0);

  if (images.length > 1) {
    timer = setInterval(()=>{ idx = (idx + 1) % images.length; loadImage(idx); }, interval);
  }
}
</script>

</body>
</html>
